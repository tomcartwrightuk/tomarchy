#!/bin/bash
# Fix Hyprland startup to use uwsm properly

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

info() { echo -e "${BLUE}==>${NC} $1"; }
success() { echo -e "${GREEN}==>${NC} $1"; }
error() { echo -e "${RED}==>${NC} $1"; }

TOMARCHY_PATH="${TOMARCHY_PATH:-$HOME/.local/share/tomarchy}"

# Check uwsm is installed
info "Checking uwsm installation..."
if ! command -v uwsm &>/dev/null; then
    error "uwsm not installed. Installing..."
    sudo pacman -S --noconfirm uwsm
fi
success "uwsm is installed"

# Fix bash_profile
info "Fixing ~/.bash_profile..."
if [[ -f ~/.bash_profile ]]; then
    # Remove old Hyprland startup lines
    sed -i '/exec Hyprland/d' ~/.bash_profile
    sed -i '/exec uwsm start hyprland/d' ~/.bash_profile
    # Remove empty comment blocks
    sed -i '/^# Start Hyprland automatically on TTY1$/d' ~/.bash_profile
    sed -i '/^# Start Hyprland automatically on TTY1 via uwsm/d' ~/.bash_profile
    sed -i '/XDG_VTNR.*1.*then/d' ~/.bash_profile
    sed -i '/^if \[ -z "\$DISPLAY" \]/d' ~/.bash_profile
    sed -i '/^fi$/d' ~/.bash_profile
fi

# Add correct startup
cat >> ~/.bash_profile << 'EOF'

# Start Hyprland via uwsm on TTY1
if [[ -z $DISPLAY && $(tty) == /dev/tty1 ]]; then
    exec uwsm start hyprland-uwsm.desktop
fi
EOF
success "~/.bash_profile updated"

# Copy fresh config files
info "Updating Hyprland config files..."
mkdir -p ~/.config/hypr
cp -f "$TOMARCHY_PATH/config/hypr/"* ~/.config/hypr/
success "Hyprland configs updated"

# Copy waybar config
info "Updating Waybar config files..."
mkdir -p ~/.config/waybar
cp -f "$TOMARCHY_PATH/config/waybar/"* ~/.config/waybar/
success "Waybar configs updated"

echo ""
success "Fix complete!"
echo ""
echo "Now run one of these:"
echo "  1. Log out and back in to TTY1"
echo "  2. Or reboot: sudo reboot"
echo ""
echo "If still not working, check:"
echo "  cat ~/.bash_profile"
echo "  cat ~/.config/hypr/autostart.conf"
